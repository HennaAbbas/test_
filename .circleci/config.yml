version: 2.1

orbs:
  ecr: pagerduty/ecr@0.0.4
  git: pagerduty/git@0.0.3        # https://circleci.com/orbs/registry/orb/pagerduty/git
#   elixir: pagerduty/elixir@0.0.9  # https://circleci.com/orbs/registry/orb/pagerduty/

build_image: &build_image
  image: cimg/base:stable-20.04

defaults: &defaults
  docker:
    - *build_image
    # - image: elasticsearch:5.3
    # - image: pagerdutypublic/kafka:04a3654
    #   environment:
    #     KAFKA_CREATE_TOPICS: "team_updates:2:1"

jobs:
  test:
    <<: *defaults
    environment:
      - MIX_ENV=test
    steps:
      - setup_remote_docker
      - checkout
      - run: ssh-add -D && echo "${GITHUB_SSH_KEY}" | base64 --decode | ssh-add - # to access private Github deps
      - git/rebase_on_main
      - run: sudo apt-get update && sudo apt install libtinfo5 libncurses5-dev
#       - elixir/install:
#           include_odbc: true
      - run: make deps
      - run: mix format --check-formatted
      - run: mix credo
      - run: mix compile --force --warnings-as-errors
      - run:
          name: 'run test suites for all applications'
          command: mix test --warnings-as-errors
  docker_publish:
    docker:
      - *build_image
    environment:
      - MIX_ENV=deploy
    steps:
      - setup_remote_docker
      - checkout
      - run: ssh-add -D && echo "${GITHUB_SSH_KEY}" | base64 --decode | ssh-add - # to access private Github deps
      - git/rebase_on_main
      - run: sudo apt-get update && sudo apt install libtinfo5 libncurses5-dev
#       - elixir/install:
#           include_odbc: true
      - run: make deps
      - run: make release
      - ecr/build-and-publish:
          repo: 'deployability-monitoring'
          dockerfile: Dockerfile
          regions: 'us-west-2,us-west-1,us-east-2,eu-central-1,eu-west-1'

workflows:
  version: 2
  test_and_publish:
    jobs:
      - test:
          context:
            - PagerDuty
            - ECR Production
      - docker_publish:
          context:
            - PagerDuty
            - ECR Production

