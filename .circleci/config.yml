orbs: # adds orbs to your configuration
  node: circleci/node@4.7.0
  codecov: codecov/codecov@3.2.0
  docker: circleci/docker@1.7.0
      
jobs:
  build:
    executor: node/default
    docker: 
      - image: rabbitmq
    steps:
      - checkout 
      - run:
          name: Install dockerize
          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.6.1      
#       - docker/install-dockerize:
#           version: v0.6.1
      - node/install-packages:
          override-ci-command: npm install
      - run:
          name: Wait for RabbitMQ to have started
          command: dockerize -wait tcp://localhost:5672 -timeout 1m

      - run:
          name: Integration Tests
          command: npm run test:integration          


version: 2.1
workflows:
  test_and_build:
    jobs:
      - build

