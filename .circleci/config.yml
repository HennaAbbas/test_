version: 2.1

orbs:
  heroku: circleci/heroku@1.2.6
  android: circleci/android@1.0.3  
  node: circleci/node@4.7.0



jobs:
  heroku_test:
    machine: true
    steps:
      - checkout
      - heroku/install
      - run:
          name: Backup database
          command: heroku pg:backups:capture --app test-app
          
  ios-staging:
    macos:
      xcode: 12.4.0
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - node/install:
          node-version: '12.18.3'
          install-yarn: true
          yarn-version: '1.22.10'      
 
  unit-test:
    executor:
      name: android/android
      sdk-version: '30'
    resource_class: large

    steps:
      - checkout 
          





  build:
    docker:
      - image: cimg/node:12.20.2
#         auth:
#           username: $DOCKERHUB_USERNAME
#           password: $DOCKERHUB_PASSWORD       
    steps:
      - checkout
      - run:
          command: |
            export YARN_VERSION=1.22.4
            sudo rm -Rf /usr/local/bin/yarn
            if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
              curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
            else
              echo "The correct version of Yarn is already installed."
            fi
            sudo ln -s $HOME/.yarn/bin/yarn /usr/local/bin/yarn
            sudo ln -s $HOME/.yarn/bin/yarn.js /usr/local/bin/yarn.js
            # export PATH=$HOME/.yarn/bin:$PATH
            yarn --version


     
      
        

  test:
    docker:
      - image: circleci/android:api-30
      
    steps:
      - run : echo "hello world - test job"        
    
            
# # #
workflows:
    build_and_push:
      jobs:
        - build
        - test
        - heroku_test
        - unit-test
        - ios-staging


#     my-workflow:
#       when:
#         and:
#           - not:
#               matches:
#                 pattern: "^master$"
#                 value: << pipeline.git.branch >>        
#       jobs:
  
#         - test                






