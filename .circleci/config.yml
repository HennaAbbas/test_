version: 2.1
orbs:
   aws-cli: circleci/aws-cli@1.0
   serverless: circleci/serverless-framework@1.0.1
_run_anchors:   
  ignore_intermediate_branches: &ignore_intermediate_branches
    filters:
      branches:
        ignore:
          - integration   
jobs:
   one:
     docker:
       - image: cimg/elixir:1.11.0-browsers
     steps:
       - run: echo $CIRCLE_TOKEN

   two:
    machine:
      image: ubuntu-2004-cuda-11.2:202103-01
    steps:
    - checkout
    - run:
        name: Setup pyenv
        command: |
          git clone https://github.com/pyenv/pyenv-update.git $(pyenv root)/plugins/pyenv-update
          pyenv update
          pyenv install -f 3.9.7
          pyenv global 3.9.7
    - run:
        name: Setup Virtual Env
        working_directory: ~/
        command: |
          python -m venv ~/venv
#          echo '. ~/venv/bin/activate' >> $BASH_ENV
#          . ~/venv/bin/activate
 #         python --version
#          which python
#          which pip
#          pip install --upgrade pip       
       
   three:
     docker:
       - image: circleci/python:3.8
     executor: serverless/default
     steps:
       - run: python --version
       - run: which python  

workflows:
  one_and_two:
    jobs:
      - one
      - two
      - two: 
         name: other two 
         <<: *ignore_intermediate_branches
      - three
