version: 2.1

orbs:
  heroku: circleci/heroku@1.2.6
  android: circleci/android@1.0.3  
  node: circleci/node@4.7.0



jobs:
  heroku_test:
    machine: true
    steps:
      - checkout


          
  ios-staging:
    macos:
      xcode: 12.4.0
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
#       - run : echo insecure >> $HOME/.curlrc
#       - node/install:
#           node-version: '12.18.3'
#           install-yarn: true
#           yarn-version: '1.22.10'      
 
  unit-test:
    executor:
      name: android/android
      sdk-version: '30'
    resource_class: large

    steps:
      - checkout 
          





  build:
    docker:
      - image: cimg/node:12.20.2
#         auth:
#           username: $DOCKERHUB_USERNAME
#           password: $DOCKERHUB_PASSWORD       
    steps:
      - checkout
      


     
      
        

  test:
    docker:
      - image: circleci/node:12.20.2
      
    steps:
      - run : echo "hello world"  
#       - run : echo 'export RUN_TEST=yes' >> $BASH_ENV
      - run : curl https://circleci.com/api/v1.1/project/${VCS_TYPE}/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BUILD_NUM} -H "Circle-Token: $CIRCLE_TOKEN"
#       - run : cat /tmp/job_info.json
#       - run: ISSUE_KEYS=$(cat /tmp/job_info.json | jq '[.all_commit_details[].subject | scan("([A-Z]{2,30}-[0-9]+)")   | .[] ] + [.all_commit_details[].branch | scan("([A-Z]{2,30}-[0-9]+)")   | .[] ] + [if .branch then .branch else "" end | scan("([A-Z]{2,30}-[0-9]+)")  | . [] ] + [if false then .all_commit_details[].body else "" end | scan("([A-Z]{2,30}-[0-9]+)")   | .[] ]')
#       - run: echo $ISSUE_KEYS
      - run: 
          command: | 
                  if [ -n "${RUN_TEST}" ]; then
                    echo "RUN_TEST is set"
                  fi

      - run: 
          command: | 

                  if [ $TEST_VAR = "testvar" ]; then
                    echo "they match"
                  else
                    echo "try again"
                    echo $TEST_VAR
                  fi
            
      - run: 
          command: | 

                  if [ $MY_ENV_VAR = "password" ]; then
                    echo "they match"
                  else
                    echo "try again"
                    echo $MY_ENV_VAR
                  fi            
# # #
workflows:
    build_and_push:
      jobs:
        - build
        - heroku_test
        - unit-test
        - ios-staging
    test: 
      jobs:
        - build
        - test    


#     my-workflow:
#       when:
#         and:
#           - not:
#               matches:
#                 pattern: "^master$"
#                 value: << pipeline.git.branch >>        
#       jobs:
  
            





